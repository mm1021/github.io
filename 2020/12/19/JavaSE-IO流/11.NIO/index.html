<!DOCTYPE html><html lang="zh_CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="JavaSE-IO流/11.NIO"><meta name="keywords" content=""><meta name="author" content="DuanChaojie,undefined"><meta name="copyright" content="DuanChaojie"><title>JavaSE-IO流/11.NIO【it❤ld】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="icon" href="/images/itbui.ico"><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  gitment: ,
  valine: ,
}</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="it❤ld" type="application/atom+xml">
</head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Java-NIO"><span class="toc-text">Java NIO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Java-NIO-简介"><span class="toc-text">1. Java NIO 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Java-NIO-与-IO-的主要区别"><span class="toc-text">2. Java NIO 与 IO 的主要区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-缓冲区-Buffer-和通道-Channel"><span class="toc-text">3. 缓冲区(Buffer)和通道(Channel)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-缓冲区-Buffer"><span class="toc-text">3.1 缓冲区(Buffer)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#缓冲区的基本属性"><span class="toc-text">缓冲区的基本属性</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#缓冲区存取数据的两个核心方法"><span class="toc-text">缓冲区存取数据的两个核心方法</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#直接缓冲区与非直接缓冲区"><span class="toc-text">直接缓冲区与非直接缓冲区</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-通道-Channel"><span class="toc-text">3.2 通道(Channel)</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Channel-接口的最主要实现类"><span class="toc-text">Channel 接口的最主要实现类</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#获取通道的三种方式"><span class="toc-text">获取通道的三种方式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#通道之间的数据传输☆"><span class="toc-text">通道之间的数据传输☆</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#FileChannel-的常用方法"><span class="toc-text">FileChannel 的常用方法</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-NIO-的非阻塞式网络通信"><span class="toc-text">4. NIO 的非阻塞式网络通信</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-阻塞与非阻塞"><span class="toc-text">4.1 阻塞与非阻塞</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#SocketChannel"><span class="toc-text">SocketChannel</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#DatagramChannel"><span class="toc-text">DatagramChannel</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#阻塞模式"><span class="toc-text">阻塞模式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#非阻塞模式"><span class="toc-text">非阻塞模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-选择器（Selector）"><span class="toc-text">4.2 选择器（Selector）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-管道"><span class="toc-text">4.3 管道</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-NIO-2"><span class="toc-text">5. NIO.2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-Path和Paths"><span class="toc-text">5.1 Path和Paths</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-Files-类"><span class="toc-text">5.2 Files 类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-自动资源管理"><span class="toc-text">5.3 自动资源管理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#☆"><span class="toc-text">☆</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/images/qad.jpg"></div><div class="author-info-name">DuanChaojie</div><div class="author-info-description">DuanChaojie的个人博客</div><div class="links-buttons"><a class="links-button button-hover" href="https://www.itbuild.cn" target="_blank">QQ: 1585636331<i class="icon-dot bg-color8"></i></a><a class="links-button button-hover" href="https://www.itbuild.cn" target="_blank">手机：17351015389<i class="icon-dot bg-color5"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">星星</span><span class="pull-bottom">89</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">7</span></a></div><div class="friend-link"><a class="friend-link-text" href="http://www.cyc2018.xyz/" target="_blank">算法训练</a><a class="friend-link-text" href="https://www.bilibili.com/" target="_blank">相约B站</a><a class="friend-link-text" href="https://account.aliyun.com/" target="_blank">图床地址</a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="title-name" href="/">it❤ld</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">JavaSE-IO流/11.NIO</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2020-12-19 | 更新于 2020-12-19</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/JavaSE-IO%E6%B5%81/">JavaSE-IO流</a></div><div class="button-hover tags"></div></div></div><div class="main-content"><p>衣带渐宽终不悔。为伊消得人憔悴。</p>
<p align="right">——柳永《蝶恋花》</p>
<a id="more"></a>


<h2 id="Java-NIO"><a href="#Java-NIO" class="headerlink" title="Java NIO"></a>Java NIO</h2><h3 id="1-Java-NIO-简介"><a href="#1-Java-NIO-简介" class="headerlink" title="1. Java NIO 简介"></a>1. Java NIO 简介</h3><blockquote>
<p>Java NIO（New IO）是从<code>Java 1.4</code>版本开始引入的一个新的IO API，可以替代标准的Java IO API。 NIO与原来的IO有同样的作用和目的，但是使用的方式完全不同，<code>NIO支持面向缓冲区的、基于通道的IO操作。</code>NIO将以更加高效的方式进行文件的读写操作。</p>
</blockquote>
<h3 id="2-Java-NIO-与-IO-的主要区别"><a href="#2-Java-NIO-与-IO-的主要区别" class="headerlink" title="2. Java NIO 与 IO 的主要区别"></a>2. Java NIO 与 IO 的主要区别</h3><table>
<thead>
<tr>
<th>IO</th>
<th align="left">NIO</th>
</tr>
</thead>
<tbody><tr>
<td>面向流(Stream Oriented)</td>
<td align="left">面向缓冲区(Buffer Oriented)</td>
</tr>
<tr>
<td>阻塞IO(Blocking IO)</td>
<td align="left">非阻塞IO(Non Blocking IO)</td>
</tr>
<tr>
<td>(无)</td>
<td align="left">选择器(Selectors)</td>
</tr>
</tbody></table>
<h3 id="3-缓冲区-Buffer-和通道-Channel"><a href="#3-缓冲区-Buffer-和通道-Channel" class="headerlink" title="3. 缓冲区(Buffer)和通道(Channel)"></a>3. 缓冲区(Buffer)和通道(Channel)</h3><blockquote>
<p><code>Java NIO系统的核心在于：通道(Channel)和缓冲区(Buffer)。</code>通道表示打开到IO 设备(例如：文件、套接字)的连接。若需要使用NIO 系统，需要获取用于连接IO 设备的通道以及用于容纳数据的缓冲区。然后操作缓冲区，对数据进行处理。</p>
<p>==简而言之，Channel 负责传输，Buffer 负责存储。==</p>
</blockquote>
<h4 id="3-1-缓冲区-Buffer"><a href="#3-1-缓冲区-Buffer" class="headerlink" title="3.1 缓冲区(Buffer)"></a>3.1 缓冲区(Buffer)</h4><blockquote>
<ul>
<li><p><code>缓冲区（Buffer）：</code>一个用于<code>特定基本数据类型的容器</code>。由<code>java.nio 包</code>定义的，<code>所有缓冲区都是Buffer 抽象类的子类。</code></p>
</li>
<li><p><code>Java NIO 中的Buffer 主要用于与NIO 通道进行交互</code>，数据是从通道读入缓冲区，从缓冲区写入通道中的。</p>
</li>
<li><p>Buffer 就像一个<code>数组</code>，可以保存多个相同类型的数据。<code>根据数据类型不同(boolean 除外) ，有以下Buffer 常用子类：</code></p>
<ul>
<li>ByteBuffer</li>
<li>ShortBuffer</li>
<li>IntBuffer</li>
<li>LongBuffer</li>
<li>FloatBuffer</li>
<li>DoubleBuffer</li>
<li>CharBuffer</li>
<li><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201108211255554.png" alt="image-20201108211255554"></li>
</ul>
</li>
<li><p>上述Buffer 类他们都采用相似的方法进行管理数据，只是各自管理的数据类型不同而已。都是通过如下方法获取一个Buffer 对象：<code>public static XxxBuffer allocate(int capacity)</code> : 创建一个容量为capacity 的XxxBuffer 对象，具体如下：</p>
</li>
<li><pre><code class="java"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IntBuffer <span class="title">allocate</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>{
    <span class="keyword">if</span> (capacity &lt; <span class="number">0</span>)
        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();
    <span class="keyword">return</span> <span class="keyword">new</span> HeapIntBuffer(capacity, capacity);
}</code></pre>
</li>
</ul>
</blockquote>
<h6 id="缓冲区的基本属性"><a href="#缓冲区的基本属性" class="headerlink" title="缓冲区的基本属性"></a>缓冲区的基本属性</h6><blockquote>
<p>Buffer 中的重要概念：</p>
<ul>
<li><code>容量(capacity)</code> ： 表示缓冲区中最大存储数据的容量。一旦声明不能改变。</li>
<li><code>限制(limit)</code>：表示缓冲区中可以操作数据的大小。（limit 后数据不能进行读写）</li>
<li><code>位置(position)</code>：表示缓冲区中正在操作数据的位置。</li>
<li><code>标记(mark)：</code>表示记录当前 position 的位置。<code>可以通过 reset() 恢复到 mark 的位置。</code></li>
<li><code>标记、位置、限制、容量遵守以下不变式： 0 &lt;= mark &lt;= position &lt;= limit &lt;= capacity</code></li>
</ul>
</blockquote>
<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201108220146505.png" alt="image-20201108220146505"></p>
<h6 id="缓冲区存取数据的两个核心方法"><a href="#缓冲区存取数据的两个核心方法" class="headerlink" title="缓冲区存取数据的两个核心方法"></a>缓冲区存取数据的两个核心方法</h6><blockquote>
<ul>
<li>put() : 存入数据到缓冲区中<ul>
<li><code>put(byte b)：</code>将给定单个字节写入缓冲区的当前位置。</li>
<li><code>put(byte[] src)：</code>将src 中的字节写入缓冲区的当前位置。</li>
<li><code>put(int index, byte b)：</code>将指定字节写入缓冲区的索引位置(不会移动position)。</li>
<li>get() : 获取缓冲区中的数据<ul>
<li><code>get() ：</code>读取单个字节。</li>
<li><code>get(byte[] dst)：</code>批量读取多个字节到dst 中。</li>
<li><code>get(int index)：</code>读取指定索引位置的字节(不会移动position)。</li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.justweb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/11/8 21:21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 10.21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> DuanChaojie</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String str = <span class="string">"abcde"</span>;</span><br><span class="line">        <span class="comment">//1. 分配一个指定大小的缓冲区</span></span><br><span class="line">        ByteBuffer buf = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"-----------------allocate()----------------"</span>);</span><br><span class="line">        System.out.println(buf.position());<span class="comment">// 0</span></span><br><span class="line">        System.out.println(buf.limit());</span><br><span class="line">        System.out.println(buf.capacity());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 利用 put() 存入数据到缓冲区中</span></span><br><span class="line">        buf.put(str.getBytes());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"-----------------put()----------------"</span>);</span><br><span class="line">        System.out.println(buf.position());<span class="comment">// 5</span></span><br><span class="line">        System.out.println(buf.limit());</span><br><span class="line">        System.out.println(buf.capacity());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 切换读取数据模式</span></span><br><span class="line">        buf.flip();</span><br><span class="line">        System.out.println(<span class="string">"-----------------flip()----------------"</span>);</span><br><span class="line">        System.out.println(buf.position());<span class="comment">// 0</span></span><br><span class="line">        System.out.println(buf.limit());<span class="comment">// 5</span></span><br><span class="line">        System.out.println(buf.capacity());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 利用 get() 读取缓冲区中的数据</span></span><br><span class="line">        <span class="keyword">byte</span>[] dst = <span class="keyword">new</span> <span class="keyword">byte</span>[buf.limit()];</span><br><span class="line">        buf.get(dst);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(dst, <span class="number">0</span>, dst.length));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"-----------------get()----------------"</span>);</span><br><span class="line">        System.out.println(buf.position());<span class="comment">// 5</span></span><br><span class="line">        System.out.println(buf.limit());<span class="comment">// 5</span></span><br><span class="line">        System.out.println(buf.capacity());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. rewind() : 可重复读</span></span><br><span class="line">        buf.rewind();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"-----------------rewind()----------------"</span>);</span><br><span class="line">        System.out.println(buf.position());<span class="comment">// 0</span></span><br><span class="line">        System.out.println(buf.limit());<span class="comment">// 5</span></span><br><span class="line">        System.out.println(buf.capacity());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6. clear() : 清空缓冲区. 但是缓冲区中的数据依然存在，但是处于“被遗忘”状态</span></span><br><span class="line">        buf.clear();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"-----------------clear()----------------"</span>);</span><br><span class="line">        System.out.println(buf.position());<span class="comment">// 0</span></span><br><span class="line">        System.out.println(buf.limit());<span class="comment">// 1024</span></span><br><span class="line">        System.out.println(buf.capacity());<span class="comment">// 1024</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 还可以读取到 a</span></span><br><span class="line">        System.out.println((<span class="keyword">char</span>)buf.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String str = <span class="string">"abcde"</span>;</span><br><span class="line">        <span class="comment">// 分配一个指定大小的缓冲区</span></span><br><span class="line">        ByteBuffer buf = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        <span class="comment">// 利用 put() 存入数据到缓冲区中</span></span><br><span class="line">        buf.put(str.getBytes());</span><br><span class="line">        <span class="comment">// 切换读取数据模式</span></span><br><span class="line">        buf.flip();</span><br><span class="line">        <span class="keyword">byte</span>[] dst = <span class="keyword">new</span> <span class="keyword">byte</span>[buf.limit()];</span><br><span class="line">        buf.get(dst,<span class="number">0</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(dst,<span class="number">0</span>,<span class="number">2</span>));<span class="comment">// ab</span></span><br><span class="line">        System.out.println(buf.position());<span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//mark():标记</span></span><br><span class="line">        buf.mark();</span><br><span class="line"></span><br><span class="line">        buf.get(dst,<span class="number">2</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(dst,<span class="number">2</span>,<span class="number">2</span>));<span class="comment">// cd</span></span><br><span class="line"></span><br><span class="line">        System.out.println(buf.position());<span class="comment">// 4</span></span><br><span class="line">        <span class="comment">// reset() ：恢复mark的位置</span></span><br><span class="line">        buf.reset();</span><br><span class="line">        System.out.println(buf.position());<span class="comment">// 2</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//判断缓冲区中是否还有剩余数据</span></span><br><span class="line">        <span class="keyword">if</span>(buf.hasRemaining())&#123;</span><br><span class="line">            <span class="comment">//获取缓冲区中可以操作的数量</span></span><br><span class="line">            System.out.println(buf.remaining());</span><br><span class="line">        &#125;    </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="直接缓冲区与非直接缓冲区"><a href="#直接缓冲区与非直接缓冲区" class="headerlink" title="直接缓冲区与非直接缓冲区"></a>直接缓冲区与非直接缓冲区</h6><blockquote>
<ul>
<li><p>非直接缓冲区：<code>通过 allocate() 方法分配缓冲区，</code>将缓冲区建立在 JVM 的内存中。</p>
<ul>
<li><p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201108224335686.png" alt="image-20201108224335686"></p>
</li>
<li><pre><code class="java">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuffer <span class="title">allocate</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>{
        <span class="keyword">if</span> (capacity &lt; <span class="number">0</span>)
            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();
        <span class="keyword">return</span> <span class="keyword">new</span> HeapByteBuffer(capacity, capacity);
    }
&lt;!--￼<span class="number">1</span>--&gt;</code></pre>
</li>
</ul>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBuffer</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="comment">//分配直接缓冲区</span></span><br><span class="line">		ByteBuffer buf = ByteBuffer.allocateDirect(<span class="number">1024</span>);</span><br><span class="line">		</span><br><span class="line">		System.out.println(buf.isDirect());<span class="comment">//true</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>字节缓冲区要么是直接的，要么是非直接的。如果为直接字节缓冲区，则Java 虚拟机会尽最大努力直接在此缓冲区上执行本机I/O 操作。也就是说，在每次调用基础操作系统的一个本机I/O 操作之前（或之后），虚拟机都会尽量避免将缓冲区的内容复制到中间缓冲区中（或从中间缓冲区中复制内容）。</li>
<li>☆直接字节缓冲区可以通过调用此类的<code>allocateDirect() 工厂方法</code>来创建。此方法返回的<code>缓冲区进行分配和取消分配所需成本通常高于非直接缓冲区</code>。直接缓冲区的内容可以驻留在常规的垃圾回收堆之外，因此，它们对应用程序的内存需求量造成的影响可能并不明显。所以，<code>建议将直接缓冲区主要分配给那些易受基础系统的本机I/O 操作影响的大型、持久的缓冲区</code>。一般情况下，最好仅在直接缓冲区能在程序性能方面带来明显好处时分配它们。</li>
<li>☆直接字节缓冲区还可以<code>通过FileChannel 的map() 方法</code>将文件区域直接映射到内存中来创建。该方法返回<code>MappedByteBuffer</code> 。Java 平台的实现有助于通过<a href="https://baike.baidu.com/item/JNI/9412164?fr=aladdin" target="_blank" rel="noopener">JNI</a> 从本机代码创建直接字节缓冲区。如果以上这些缓冲区中的某个缓冲区实例指的是不可访问的内存区域，则试图访问该区域不会更改该缓冲区的内容，并且将会在访问期间或稍后的某个时间导致抛出不确定的异常。</li>
<li>字节缓冲区是直接缓冲区还是非直接缓冲区可通过调用其<code>isDirect() 方法</code>来确定。提供此方法是为了能够在性能关键型代码中执行显式缓冲区管理。</li>
</ul>
</blockquote>
<h4 id="3-2-通道-Channel"><a href="#3-2-通道-Channel" class="headerlink" title="3.2 通道(Channel)"></a>3.2 通道(Channel)</h4><blockquote>
<p>通道（Channel）<code>：由java.nio.channels 包定义的</code>。Channel <code>表示IO 源与目标打开的连接</code>。 Channel 类似于传统的“流”。在 Java NIO 中负责缓冲区中数据的传输。Channel 本身不存储数据，因此需要配合缓冲区进行传输。</p>
</blockquote>
<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201109112102245.png" alt="image-20201109112102245"></p>
<blockquote>
<ol>
<li><a href="https://blog.csdn.net/dadalan/article/details/2802979" target="_blank" rel="noopener">什么是DMA</a></li>
<li><a href="https://my.oschina.net/u/3847203/blog/4525154" target="_blank" rel="noopener">DMA 和 Channel 的区别</a></li>
</ol>
</blockquote>
<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201109112111503.png" alt="image-20201109112111503"></p>
<h6 id="Channel-接口的最主要实现类"><a href="#Channel-接口的最主要实现类" class="headerlink" title="Channel 接口的最主要实现类"></a>Channel 接口的最主要实现类</h6><blockquote>
<p><code>java.nio.channels.Channel 接口：</code></p>
<ul>
<li><code>FileChannel：</code>用于读取、写入、映射和操作文件的通道。</li>
<li><code>DatagramChannel：</code>通过 UDP 读写网络中的数据通道。</li>
<li><code>SocketChannel：</code>通过 TCP 读写网络中的数据。</li>
<li><code>ServerSocketChannel：</code>可以监听新进来的 TCP 连接，对每一个新进来的链接都会创建一个SocketChannel。</li>
</ul>
</blockquote>
<h6 id="获取通道的三种方式"><a href="#获取通道的三种方式" class="headerlink" title="获取通道的三种方式"></a>获取通道的三种方式</h6><blockquote>
<ol>
<li><p>Java 针对支持通道的类提供了 <code>getChannel() 方法。</code></p>
<ul>
<li>本地 IO：<ul>
<li>FileInputStream/FileOutputStream</li>
<li>RandomAccessFile</li>
</ul>
</li>
<li>网络IO：<ul>
<li>Socket</li>
<li>ServerSocket</li>
<li>DatagramSocket</li>
</ul>
</li>
</ul>
</li>
<li><p>在 JDK 1.7 中的 NIO.2 <code>针对各个通道提供了静态方法 open()</code>。</p>
</li>
<li><p>在 JDK 1.7 中的 NIO.2 的 <code>Files 工具类的 newByteChannel()。</code></p>
</li>
</ol>
</blockquote>
<h6 id="通道之间的数据传输☆"><a href="#通道之间的数据传输☆" class="headerlink" title="通道之间的数据传输☆"></a>通道之间的数据传输<code>☆</code></h6><blockquote>
<ol>
<li><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201109113302447.png" alt="image-20201109113302447"></li>
<li><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201109113312395.png" alt="image-20201109113312395"></li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 利用通道完成文件的复制（非直接缓冲区）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">    FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">    FileChannel inChannel = <span class="keyword">null</span>;</span><br><span class="line">    FileChannel outChannel = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        fis = <span class="keyword">new</span> FileInputStream(<span class="string">"E:\\file\\1988第一段.mp4"</span>);</span><br><span class="line">        fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"E:\\file\\1988-copy1.mp4"</span>);</span><br><span class="line">        inChannel = fis.getChannel();</span><br><span class="line">        outChannel = fos.getChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1、分配指定大小的缓冲区</span></span><br><span class="line">        ByteBuffer buf = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2、将通道中的数据存入缓冲区</span></span><br><span class="line">        <span class="keyword">while</span>(inChannel.read(buf) != -<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">// 切换读取数据模式</span></span><br><span class="line">            buf.flip();</span><br><span class="line">            <span class="comment">// 将缓冲区中的数据写入通道中</span></span><br><span class="line">            outChannel.write(buf);</span><br><span class="line">            <span class="comment">// 清空缓冲区</span></span><br><span class="line">            buf.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 关闭流资源，先开后关</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            outChannel.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            inChannel.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fis.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> start = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> end = <span class="number">0</span>;</span><br><span class="line">    FileChannel inChannel = <span class="keyword">null</span>;</span><br><span class="line">    FileChannel outChannel = <span class="keyword">null</span>;</span><br><span class="line">    MappedByteBuffer inMappedBuf = <span class="keyword">null</span>;</span><br><span class="line">    MappedByteBuffer outMappedBuf = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        inChannel = FileChannel.open(Paths.get(<span class="string">"E:\\file\\1988第一段.mp4"</span>), StandardOpenOption.READ);</span><br><span class="line">        outChannel = FileChannel.open(Paths.get(<span class="string">"E:\\file\\1988-copy2.mp4"</span>), StandardOpenOption.WRITE, StandardOpenOption.READ, StandardOpenOption.CREATE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 内存映射文件</span></span><br><span class="line">        inMappedBuf = inChannel.map(FileChannel.MapMode.READ_ONLY, <span class="number">0</span>, inChannel.size());</span><br><span class="line">        outMappedBuf = outChannel.map(FileChannel.MapMode.READ_WRITE, <span class="number">0</span>, inChannel.size());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 直接缓冲区进行数据读写操作</span></span><br><span class="line">        <span class="keyword">byte</span>[] dst = <span class="keyword">new</span> <span class="keyword">byte</span>[inMappedBuf.limit()];</span><br><span class="line">        inMappedBuf.get(dst);</span><br><span class="line">        outMappedBuf.put(dst);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            inChannel.close();</span><br><span class="line">            outChannel.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"耗费时间为："</span> + (end - start));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>分散(Scatter)与聚集(Gather)</code></p>
<ul>
<li>分散读取（Scattering Reads）：将通道中的数据分散到多个缓冲区中。<ul>
<li><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201109114159944.png" alt="image-20201109114159944"></li>
</ul>
</li>
<li>聚集写入（Gathering Writes）：将多个缓冲区中的数据聚集到通道中。<ul>
<li><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201109114136231.png" alt="image-20201109114136231"></li>
</ul>
</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分散和聚集</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span></span>&#123;</span><br><span class="line">    RandomAccessFile raf1 = <span class="keyword">null</span>;</span><br><span class="line">    RandomAccessFile raf2= <span class="keyword">null</span>;</span><br><span class="line">    FileChannel channel1 = <span class="keyword">null</span>;</span><br><span class="line">    FileChannel channel2 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        raf1 = <span class="keyword">new</span> RandomAccessFile(<span class="string">"1.txt"</span>, <span class="string">"rw"</span>);</span><br><span class="line">        <span class="comment">// 1.获取通道</span></span><br><span class="line">        channel1 = raf1.getChannel();</span><br><span class="line">        <span class="comment">// 2.分配制定大小的缓冲区</span></span><br><span class="line">        ByteBuffer buf1 = ByteBuffer.allocate(<span class="number">100</span>);</span><br><span class="line">        ByteBuffer buf2 = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.分散读取</span></span><br><span class="line">        ByteBuffer[] bufs = &#123;buf1,buf2&#125;;</span><br><span class="line">        channel1.read(bufs);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ByteBuffer buf : bufs) &#123;</span><br><span class="line">            buf.flip();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(bufs[<span class="number">0</span>].array(),<span class="number">0</span>,bufs[<span class="number">0</span>].limit()));</span><br><span class="line">        System.out.println(<span class="string">"---------------------------------------------"</span>);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(bufs[<span class="number">1</span>].array(),<span class="number">0</span>,bufs[<span class="number">1</span>].limit()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.聚集写入</span></span><br><span class="line">        raf2 = <span class="keyword">new</span> RandomAccessFile(<span class="string">"2.txt"</span>, <span class="string">"rw"</span>);</span><br><span class="line">        channel2 = raf2.getChannel();</span><br><span class="line">        channel2.write(bufs);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channel2.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            raf2.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channel1.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            raf1.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>transferFrom()和transferTo()</code></p>
<ul>
<li><code>transferFrom()</code> 将数据从源通道传输到其他 Channel 中。</li>
<li><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201109114732130.png" alt="image-20201109114732130"></li>
<li><code>transferTo()</code>  将数据从源通道传输到其他 Channel 中。</li>
<li><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201109114741147.png" alt="image-20201109114741147"></li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 通道之间的数据传输(直接缓冲区)</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span></span>&#123;</span><br><span class="line">     FileChannel inChannel = <span class="keyword">null</span>;</span><br><span class="line">     FileChannel outChannel = <span class="keyword">null</span>;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         inChannel = FileChannel.open(Paths.get(<span class="string">"E:\\file\\1988第一段.mp4"</span>), StandardOpenOption.READ);</span><br><span class="line">         outChannel = FileChannel.open(Paths.get(<span class="string">"E:\\file\\1988-copy3.mp4"</span>), StandardOpenOption.WRITE, StandardOpenOption.READ, StandardOpenOption.CREATE);</span><br><span class="line">         <span class="comment">//inChannel.transferTo(0,inChannel.size(),outChannel);</span></span><br><span class="line">         outChannel.transferFrom(inChannel,<span class="number">0</span>,inChannel.size());</span><br><span class="line"></span><br><span class="line">     &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">     &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             inChannel.close();</span><br><span class="line">         &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             outChannel.close();</span><br><span class="line">         &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>字符集：Charset</code></p>
<ul>
<li>编码：字符串 -&gt; 字节数组</li>
<li>解码：字节数组  -&gt; 字符串</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Charset</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Charset cs1 = Charset.forName(<span class="string">"GBK"</span>);</span><br><span class="line">        <span class="comment">// 获取编码器</span></span><br><span class="line">        CharsetEncoder ce = cs1.newEncoder();</span><br><span class="line">        <span class="comment">// 获取解码器</span></span><br><span class="line">        CharsetDecoder cd = cs1.newDecoder();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建缓冲区</span></span><br><span class="line">        CharBuffer cBuf = CharBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">        cBuf.put(<span class="string">"Justweb程序员"</span>);</span><br><span class="line">        cBuf.flip();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 编码</span></span><br><span class="line">        ByteBuffer bBuf = ce.encode(cBuf);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">13</span>; i++) &#123;</span><br><span class="line">            System.out.println(bBuf.get());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解码</span></span><br><span class="line">        bBuf.flip();</span><br><span class="line">        CharBuffer cBuf2 = cd.decode(bBuf);</span><br><span class="line">        System.out.println(cBuf2.toString());</span><br><span class="line">        System.out.println(<span class="string">"----------------------------"</span>);</span><br><span class="line">        </span><br><span class="line">        Charset cs2 = Charset.forName(<span class="string">"UTF-8"</span>);</span><br><span class="line">        bBuf.flip();</span><br><span class="line">        CharBuffer cBuf3 = cs2.decode(bBuf);</span><br><span class="line">        System.out.println(cBuf3.toString());</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (CharacterCodingException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="FileChannel-的常用方法"><a href="#FileChannel-的常用方法" class="headerlink" title="FileChannel 的常用方法"></a>FileChannel 的常用方法</h6><p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201109114921208.png" alt="image-20201109114921208"></p>
<h3 id="4-NIO-的非阻塞式网络通信"><a href="#4-NIO-的非阻塞式网络通信" class="headerlink" title="4. NIO 的非阻塞式网络通信"></a>4. NIO 的非阻塞式网络通信</h3><h4 id="4-1-阻塞与非阻塞"><a href="#4-1-阻塞与非阻塞" class="headerlink" title="4.1 阻塞与非阻塞"></a>4.1 阻塞与非阻塞</h4><blockquote>
<ol>
<li><code>传统的IO 流都是阻塞式的。</code>也就是说，当一个线程调用read() 或write()时，该线程被阻塞，直到有一些数据被读取或写入，该线程在此期间不能执行其他任务。因此，在完成网络通信进行IO 操作时，由于线程会阻塞，所以服务器端必须为每个客户端都提供一个独立的线程进行处理，当服务器端需要处理大量客户端时，性能急剧下降。</li>
<li><code>Java NIO 是非阻塞模式的。</code>当线程从某通道进行读写数据时，若没有数据可用时，该线程可以进行其他任务。线程通常将非阻塞IO 的空闲时间用于在其他通道上执行IO 操作，所以单独的线程可以管理多个输入和输出通道。因此，NIO 可以让服务器端使用一个或有限几个线程来同时处理连接到服务器端的所有客户端。</li>
<li><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/feizuse.png" alt="feizuse"><ul>
<li><code>比阻塞模式多了个Selector。</code></li>
</ul>
</li>
</ol>
</blockquote>
<h6 id="SocketChannel"><a href="#SocketChannel" class="headerlink" title="SocketChannel"></a>SocketChannel</h6><blockquote>
<ol>
<li>Java NIO中的SocketChannel是一个连接到TCP网络套接字的通道。</li>
<li>操作步骤：<ul>
<li>打开SocketChannel</li>
<li>读写数据</li>
<li>关闭SocketChannel</li>
</ul>
</li>
<li>Java NIO中的ServerSocketChannel 是一个可以监听新进来的TCP连接的通道，就像标准IO中的ServerSocket一样。</li>
</ol>
</blockquote>
<h6 id="DatagramChannel"><a href="#DatagramChannel" class="headerlink" title="DatagramChannel"></a>DatagramChannel</h6><blockquote>
<ol>
<li>Java NIO中的DatagramChannel是一个能收发UDP包的通道。</li>
<li>操作步骤：<ul>
<li>打开DatagramChannel</li>
<li>接收/发送数据</li>
</ul>
</li>
</ol>
</blockquote>
<h6 id="阻塞模式"><a href="#阻塞模式" class="headerlink" title="阻塞模式"></a>阻塞模式</h6><blockquote>
<ol>
<li><p>使用 NIO 完成网络通信的三个核心：</p>
<ol>
<li><p>通道（Channel）：负责连接</p>
<ul>
<li><p>java.nio.channels.Channel 接口：</p>
<p>​    |–SelectableChannel</p>
<p>​    |–SocketChannel</p>
<p>​    |–ServerSocketChannel</p>
<p>​    |–DatagramChannel</p>
</li>
</ul>
</li>
</ol>
</li>
</ol>
<pre><code>​    |--Pipe.SinkChannel

​    |--Pipe.SourceChannel</code></pre><ol start="2">
<li><p>缓冲区（Buffer）：负责数据的存取。</p>
</li>
<li><p>选择器（Selector）：是 SelectableChannel 的多路复用器。用于监控 SelectableChannel 的 IO 状况。</p>
</li>
</ol>
<ol start="2">
<li><a href="https://blog.csdn.net/z_xindong/article/details/85051458" target="_blank" rel="noopener">Java中InetAddress与InetSocketAddress的基本用法</a></li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.justweb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.FileChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.StandardOpenOption;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/11/9 21:17</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 10.21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> DuanChaojie</span></span><br><span class="line"><span class="comment"> * 先运行server再运行client</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockingNIOTest</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">client</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SocketChannel sChannel = <span class="keyword">null</span>;</span><br><span class="line">        FileChannel inChannel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.获取通道</span></span><br><span class="line">            sChannel = SocketChannel.open(<span class="keyword">new</span> InetSocketAddress(<span class="string">"127.0.0.1"</span>, <span class="number">1021</span>));</span><br><span class="line">            inChannel = FileChannel.open(Paths.get(<span class="string">"1.jpg"</span>), StandardOpenOption.READ);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.分配指定大小的缓冲区</span></span><br><span class="line">            ByteBuffer buf = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.读取本地文件，并发送到服务端</span></span><br><span class="line">            <span class="keyword">while</span> (inChannel.read(buf) != -<span class="number">1</span>)&#123;</span><br><span class="line">                buf.flip();</span><br><span class="line">                sChannel.write(buf);</span><br><span class="line">                buf.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 4.关闭通道</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                inChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">server</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ServerSocketChannel ssChannel = <span class="keyword">null</span>;</span><br><span class="line">        FileChannel outChannel = <span class="keyword">null</span>;</span><br><span class="line">        SocketChannel sChannel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.获取通道</span></span><br><span class="line">            ssChannel = ServerSocketChannel.open();</span><br><span class="line">            outChannel = FileChannel.open(Paths.get(<span class="string">"2.jpg"</span>), StandardOpenOption.WRITE, StandardOpenOption.CREATE);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.绑定链接</span></span><br><span class="line">            ssChannel.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">1021</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 3.获取客户端连接的通道</span></span><br><span class="line">            sChannel = ssChannel.accept();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 4.分配指定大小的缓冲区</span></span><br><span class="line">            ByteBuffer buf = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">            <span class="comment">// 5.接收客户端的数据，并保存到本地</span></span><br><span class="line">            <span class="keyword">while</span>(sChannel.read(buf) != -<span class="number">1</span>)&#123;</span><br><span class="line">                buf.flip();</span><br><span class="line">                outChannel.write(buf);</span><br><span class="line">                buf.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 6.关闭通道</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                outChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ssChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>BlockingNIO2Test</code>:完成阻塞时双向通信。</p>
<ul>
<li><code>sChannel.shutdownOutput();</code></li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.justweb;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.FileChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.ServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SocketChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.StandardOpenOption;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/11/9 21:50</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 10.21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> DuanChaojie</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockingNIO2Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">client</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SocketChannel sChannel = <span class="keyword">null</span>;</span><br><span class="line">        FileChannel inChannel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sChannel = SocketChannel.open(<span class="keyword">new</span> InetSocketAddress(<span class="string">"127.0.0.1"</span>, <span class="number">1021</span>));</span><br><span class="line">            inChannel = FileChannel.open(Paths.get(<span class="string">"1.jpg"</span>), StandardOpenOption.READ);</span><br><span class="line">            ByteBuffer buf = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">            <span class="keyword">while</span> (inChannel.read(buf) != -<span class="number">1</span>) &#123;</span><br><span class="line">                buf.flip();</span><br><span class="line">                sChannel.write(buf);</span><br><span class="line">                buf.clear();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            sChannel.shutdownOutput();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 接收服务端的反馈</span></span><br><span class="line">            <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((len = sChannel.read(buf)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                </span><br><span class="line">                buf.flip();</span><br><span class="line">                System.out.println(<span class="keyword">new</span> String(buf.array(), <span class="number">0</span>, len));</span><br><span class="line">                buf.clear();</span><br><span class="line">              </span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                inChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ServerSocketChannel ssChannel = <span class="keyword">null</span>;</span><br><span class="line">        FileChannel outChannel = <span class="keyword">null</span>;</span><br><span class="line">        SocketChannel sChannel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ssChannel = ServerSocketChannel.open();</span><br><span class="line"></span><br><span class="line">            outChannel = FileChannel.open(Paths.get(<span class="string">"2.jpg"</span>), StandardOpenOption.WRITE, StandardOpenOption.CREATE);</span><br><span class="line"></span><br><span class="line">            ssChannel.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">1021</span>));</span><br><span class="line"></span><br><span class="line">            sChannel = ssChannel.accept();</span><br><span class="line"></span><br><span class="line">            ByteBuffer buf = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (sChannel.read(buf) != -<span class="number">1</span>) &#123;</span><br><span class="line">                buf.flip();</span><br><span class="line">                outChannel.write(buf);</span><br><span class="line">                buf.clear();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 发送反馈给客户端</span></span><br><span class="line">            buf.put(<span class="string">"服务端接收数据成功"</span>.getBytes());</span><br><span class="line">            buf.flip();</span><br><span class="line">            sChannel.write(buf);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                outChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ssChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="非阻塞模式"><a href="#非阻塞模式" class="headerlink" title="非阻塞模式"></a>非阻塞模式</h6><blockquote>
<p><a href="https://www.cnblogs.com/liqbk/p/13598638.html" target="_blank" rel="noopener">解决junit测试的时候,不能在控制台进行输入</a></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.justweb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/11/9 22:21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 10.21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> DuanChaojie</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NonBlockingNIOTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">client</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SocketChannel sChannel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.获取通道</span></span><br><span class="line">            sChannel = SocketChannel.open(<span class="keyword">new</span> InetSocketAddress(<span class="string">"127.0.0.1"</span>, <span class="number">1021</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.切换非阻塞模式</span></span><br><span class="line">            sChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.分配指定大小的缓冲区</span></span><br><span class="line">            ByteBuffer buf = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4.发送数据给服务端</span></span><br><span class="line">            Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">            <span class="keyword">while</span> (scan.hasNext()) &#123;</span><br><span class="line">                String str = scan.next();</span><br><span class="line">                buf.put((<span class="keyword">new</span> Date().toString() + <span class="string">"\n"</span> + str).getBytes());</span><br><span class="line">                buf.flip();</span><br><span class="line">                sChannel.write(buf);</span><br><span class="line">                buf.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 5.关闭通道</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">server</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ServerSocketChannel ssChannel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.获取通道</span></span><br><span class="line">            ssChannel = ServerSocketChannel.open();</span><br><span class="line">            <span class="comment">// 2.切换非阻塞模式</span></span><br><span class="line">            ssChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.绑定链接</span></span><br><span class="line">            ssChannel.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">1021</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4.获取选择器</span></span><br><span class="line">            Selector selector = Selector.open();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5.将通道注册的到选择器上，并且指定“监听接收事件”</span></span><br><span class="line">            ssChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6.轮询式的获取选择器上已经“准备就绪”的事件</span></span><br><span class="line">            <span class="keyword">while</span> (selector.select() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 7.获取当前选择器中所有注册的“选择键（已就绪的监听事件）”</span></span><br><span class="line">                Iterator&lt;SelectionKey&gt; it = selector.selectedKeys().iterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                    <span class="comment">// 8.获取准备“就绪”的事件</span></span><br><span class="line">                    SelectionKey sk = it.next();</span><br><span class="line">                    <span class="comment">// 9.判断具体是什么事件准备就绪</span></span><br><span class="line">                    <span class="keyword">if</span> (sk.isAcceptable()) &#123;</span><br><span class="line">                        <span class="comment">// 10.若“接收就绪”，获取客户端连接</span></span><br><span class="line">                        SocketChannel sChannel = ssChannel.accept();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 11.切换非阻塞模式</span></span><br><span class="line">                        sChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 12.将该通道注册到选择器上</span></span><br><span class="line">                        sChannel.register(selector, SelectionKey.OP_READ);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sk.isReadable()) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 13.获取当前选择器上“读就绪”状态的通道</span></span><br><span class="line">                        SocketChannel sChannel = (SocketChannel) sk.channel();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 14.读取数据</span></span><br><span class="line">                        ByteBuffer buf = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">                        <span class="comment">///// 这个地方为什么是大于0</span></span><br><span class="line">                        <span class="keyword">while</span> ((len = sChannel.read(buf)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            buf.flip();</span><br><span class="line">                            System.out.println(<span class="keyword">new</span> String(buf.array(), <span class="number">0</span>, len));</span><br><span class="line">                            buf.clear();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 15.取消选择键 SelectionKey</span></span><br><span class="line">                    it.remove();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ssChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>NonBlockingNIO2Test</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.justweb;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.DatagramChannel;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.SelectionKey;</span><br><span class="line"><span class="keyword">import</span> java.nio.channels.Selector;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/11/10 9:18</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 10.21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> DuanChaojie</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NonBlockingNIO2Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DatagramChannel dc = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dc = DatagramChannel.open();</span><br><span class="line">            dc.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">            Scanner scan = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (scan.hasNext()) &#123;</span><br><span class="line">                String str = scan.next();</span><br><span class="line">                buffer.put((<span class="keyword">new</span> Date() + <span class="string">"\n"</span> + str).getBytes());</span><br><span class="line">                buffer.flip();</span><br><span class="line">                dc.send(buffer, <span class="keyword">new</span> InetSocketAddress(<span class="string">"127.0.0.1"</span>, <span class="number">1021</span>));</span><br><span class="line">                buffer.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                dc.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DatagramChannel dc = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dc = DatagramChannel.open();</span><br><span class="line">            dc.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            dc.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">1021</span>));</span><br><span class="line">            Selector selector = Selector.open();</span><br><span class="line">            dc.register(selector, SelectionKey.OP_READ);</span><br><span class="line">            <span class="keyword">while</span> (selector.select() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                Iterator&lt;SelectionKey&gt; it = selector.selectedKeys().iterator();</span><br><span class="line">                <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                    SelectionKey sk = it.next();</span><br><span class="line">                    <span class="keyword">if</span> (sk.isReadable()) &#123;</span><br><span class="line">                        ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                        dc.receive(buffer);</span><br><span class="line">                        buffer.flip();</span><br><span class="line">                        System.out.println(<span class="keyword">new</span> String(buffer.array(), <span class="number">0</span>, buffer.limit()));</span><br><span class="line">                        buffer.clear();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                it.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-选择器（Selector）"><a href="#4-2-选择器（Selector）" class="headerlink" title="4.2 选择器（Selector）"></a>4.2 选择器（Selector）</h4><blockquote>
<ol>
<li><code>选择器（Selector）</code>是SelectableChannle 对象的多路复用器，Selector 可以同时监控多个SelectableChannel 的IO 状况，也就是说，利用Selector可使一个单独的线程管理多个Channel。<code>Selector 是非阻塞IO 的核心。</code>SelectableChannle 的结构如下图：</li>
<li><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201110094923388.png" alt="image-20201110094923388"></li>
<li>通过调用Selector.open() 方法创建一个Selector。</li>
<li>向选择器注册通道：<code>SelectableChannel.register(Selector sel,int ops);</code>当调用register(Selector sel, int ops)  将通道注册选择器时，选择器对通道的监听事件，需要通过第二个参数ops 指定。<ul>
<li>可以监听的事件类型（可使用SelectionKey 的四个常量表示）：<ul>
<li><code>读: SelectionKey.OP_READ  （1）</code></li>
<li><code>写: SelectionKey.OP_WRITE    （4）</code></li>
<li><code>连接: SelectionKey.OP_CONNECT （8）</code></li>
<li><code>接收: SelectionKey.OP_ACCEPT  （16）</code></li>
</ul>
</li>
<li><code>SelectionKey：表示SelectableChannel 和Selector 之间的注册关系。</code>每次向选择器注册通道时就会选择一个事件(选择键)。选择键包含两个表示为整数值的操作集。操作集的每一位都表示该键的通道所支持的一类可选择操作。下面是SelectionKey的常用方法：</li>
<li><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201110095515168.png" alt="image-20201110095515168"></li>
</ul>
</li>
</ol>
</blockquote>
<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201110095619346.png" alt="image-20201110095619346"></p>
<h4 id="4-3-管道"><a href="#4-3-管道" class="headerlink" title="4.3 管道"></a>4.3 管道</h4><blockquote>
<p>Java NIO 管道是2个线程之间的单向数据连接。 Pipe有一个source通道和一个sink通道。数据会被写到sink通道，从source通道读取。</p>
<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/JavaSE-IO%E6%B5%81/image-20201110100559591.png" alt="image-20201110100559591"></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2020/11/10 9:35</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 10.21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> DuanChaojie</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PipeTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Pipe.SinkChannel sinkChannel = <span class="keyword">null</span>;</span><br><span class="line">        Pipe.SourceChannel sourceChannel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.获取管道</span></span><br><span class="line">            Pipe pipe = Pipe.open();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.将缓冲区中的数据写入管道</span></span><br><span class="line">            ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">            sinkChannel = pipe.sink();</span><br><span class="line">            buffer.put(<span class="string">"通过单向通道发送数据"</span>.getBytes());</span><br><span class="line">            buffer.flip();</span><br><span class="line">            sinkChannel.write(buffer);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.读取缓冲区中的数据</span></span><br><span class="line">            sourceChannel = pipe.source();</span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="keyword">int</span> len = sourceChannel.read(buffer);</span><br><span class="line">            System.out.println(<span class="keyword">new</span> String(buffer.array(), <span class="number">0</span>, len));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sourceChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sinkChannel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-NIO-2"><a href="#5-NIO-2" class="headerlink" title="5. NIO.2"></a>5. NIO.2</h3><blockquote>
<p>随着JDK 7 的发布，Java对NIO进行了极大的扩展，增强了对文件处理和文件系统特性的支持，以至于我们称他们为NIO.2。因为NIO 提供的一些功能，NIO已经成为文件处理中越来越重要的部分。</p>
</blockquote>
<h4 id="5-1-Path和Paths"><a href="#5-1-Path和Paths" class="headerlink" title="5.1 Path和Paths"></a>5.1 Path和Paths</h4><blockquote>
<ol>
<li><p>java.nio.file.Path 接口代表一个平台无关的平台路径，描述了目录结构中文件的位置。</p>
</li>
<li><p>Paths 提供的get() 方法用来获取Path 对象：</p>
<ul>
<li><code>Path get(String first, String … more) : 用于将多个字符串串连成路径。</code></li>
</ul>
</li>
<li><table>
<thead>
<tr>
<th align="left">Path 常用方法：</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>boolean endsWith(String path) :</code> 判断是否以 path 路径结束</td>
</tr>
<tr>
<td align="left"><code>boolean startsWith(String path) :</code> 判断是否以 path 路径开始</td>
</tr>
<tr>
<td align="left"><code>boolean isAbsolute() :</code> 判断是否是绝对路径</td>
</tr>
<tr>
<td align="left"><code>Path getFileName() :</code> 返回与调用 Path 对象关联的文件名</td>
</tr>
<tr>
<td align="left"><code>Path getName(int idx) :</code> 返回的指定索引位置 idx 的路径名称</td>
</tr>
<tr>
<td align="left"><code>int getNameCount() :</code> 返回Path 根目录后面元素的数量</td>
</tr>
<tr>
<td align="left"><code>Path getParent() ：</code>返回Path对象包含整个路径，不包含 Path 对象指定的文件路径</td>
</tr>
<tr>
<td align="left"><code>Path getRoot() ：</code>返回调用 Path 对象的根路径</td>
</tr>
<tr>
<td align="left"><code>Path resolve(Path p) :</code>将相对路径解析为绝对路径</td>
</tr>
<tr>
<td align="left"><code>Path toAbsolutePath() :</code> 作为绝对路径返回调用 Path 对象</td>
</tr>
<tr>
<td align="left"><code>String toString() ：</code> 返回调用 Path 对象的字符串表示形式</td>
</tr>
</tbody></table>
</li>
</ol>
</blockquote>
<h4 id="5-2-Files-类"><a href="#5-2-Files-类" class="headerlink" title="5.2 Files 类"></a>5.2 Files 类</h4><blockquote>
<ol>
<li><a href="https://blog.csdn.net/weixin_45267102/article/details/106698646" target="_blank" rel="noopener"> Java基础之File类</a></li>
<li>java.nio.file.Files用于操作文件或目录的<code>工具类。</code></li>
<li><code>Files常用方法：</code></li>
</ol>
<table>
<thead>
<tr>
<th>Path copy(Path src, Path dest, CopyOption … how) : 文件的复制</th>
</tr>
</thead>
<tbody><tr>
<td>Path createDirectory(Path path, FileAttribute&lt;?&gt; … attr) : 创建一个目录</td>
</tr>
<tr>
<td>Path createFile(Path path, FileAttribute&lt;?&gt; … arr) : 创建一个文件</td>
</tr>
<tr>
<td>void delete(Path path) : 删除一个文件</td>
</tr>
<tr>
<td>Path move(Path src, Path dest, CopyOption…how) : 将 src 移动到 dest 位置</td>
</tr>
<tr>
<td>long size(Path path) : 返回 path 指定文件的大小</td>
</tr>
</tbody></table>
<ol start="4">
<li><code>Files常用方法：用于判断</code></li>
</ol>
<table>
<thead>
<tr>
<th>boolean exists(Path path, LinkOption … opts) : 判断文件是否存在</th>
</tr>
</thead>
<tbody><tr>
<td>boolean isDirectory(Path path, LinkOption … opts) : 判断是否是目录</td>
</tr>
<tr>
<td>boolean isExecutable(Path path) : 判断是否是可执行文件</td>
</tr>
<tr>
<td>boolean isHidden(Path path) : 判断是否是隐藏文件</td>
</tr>
<tr>
<td>boolean isReadable(Path path) : 判断文件是否可读</td>
</tr>
<tr>
<td>boolean isWritable(Path path) : 判断文件是否可写</td>
</tr>
<tr>
<td>boolean notExists(Path path, LinkOption … opts) : 判断文件是否不存在</td>
</tr>
<tr>
<td>public static <A extends BasicFileAttributes> A readAttributes(Path path,Class<A> type,LinkOption… options) : 获取与 path 指定的文件相关联的属性。</td>
</tr>
</tbody></table>
<ol start="5">
<li><code>Files常用方法：用于操作内容</code></li>
</ol>
<table>
<thead>
<tr>
<th>SeekableByteChannel newByteChannel(Path path, OpenOption…how) : 获取与指定文件的连接，how 指定打开方式。</th>
</tr>
</thead>
<tbody><tr>
<td>DirectoryStream newDirectoryStream(Path path) : 打开 path 指定的目录</td>
</tr>
<tr>
<td>InputStream newInputStream(Path path, OpenOption…how):获取 InputStream 对象</td>
</tr>
<tr>
<td>OutputStream newOutputStream(Path path, OpenOption…how) : 获取 OutputStream 对象</td>
</tr>
</tbody></table>
</blockquote>
<h4 id="5-3-自动资源管理"><a href="#5-3-自动资源管理" class="headerlink" title="5.3 自动资源管理"></a>5.3 自动资源管理</h4><blockquote>
<p><a href="https://blog.csdn.net/weixin_45267102/article/details/106711053" target="_blank" rel="noopener">Java 7 增加了一个新特性，该特性提供了另外一种管理资源的方式，</a>这种方式能自动关闭文件。这个特性有时被称为自动资源管理(Automatic Resource Management, ARM)，该特性以try 语句的扩展版为基础。自动资源管理主要用于，当不再需要文件（或其他资源）时，可以防止无意中忘记释放它们。</p>
</blockquote>
<h2 id="☆"><a href="#☆" class="headerlink" title="☆"></a>☆</h2></div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">DuanChaojie</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="http://www.itbuild.cn/2020/12/19/JavaSE-IO%E6%B5%81/11.NIO/">http://www.itbuild.cn/2020/12/19/JavaSE-IO%E6%B5%81/11.NIO/</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.itbuild.cn">it❤ld</a>！</span></div></div></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2020/12/19/JavaSE-JVM/1.Java%E5%8F%8AJVM%E7%AE%80%E4%BB%8B/"><i class="fas fa-angle-left">&nbsp;</i><span>JavaSE-JVM/1.Java及JVM简介</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2020/12/19/JavaSE-IO%E6%B5%81/9.IO%E6%B5%81%E4%B9%8B%E6%89%93%E5%8D%B0%E6%B5%81/"><span>JavaSE-IO流/9.IO流之打印流</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2020 By DuanChaojie</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--></body></html>