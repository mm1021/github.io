<!DOCTYPE html><html lang="zh_CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="MySql高级/3.MySql高级之存储过程和函数"><meta name="keywords" content=""><meta name="author" content="DuanChaojie,undefined"><meta name="copyright" content="DuanChaojie"><title>MySql高级/3.MySql高级之存储过程和函数【it❤ld】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="icon" href="/images/itbui.ico"><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  gitment: ,
  valine: ,
}</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="it❤ld" type="application/atom+xml">
</head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#MySql高级之存储过程和函数"><span class="toc-text">MySql高级之存储过程和函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-存储过程和函数概述"><span class="toc-text">1. 存储过程和函数概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-创建存储过程"><span class="toc-text">2. 创建存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-调用存储过程"><span class="toc-text">3.  调用存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-查看存储过程"><span class="toc-text">4. 查看存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-删除存储过程"><span class="toc-text">5. 删除存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-语法"><span class="toc-text">6. 语法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-1-变量"><span class="toc-text">6.1 变量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-if条件判断"><span class="toc-text">6.2 if条件判断</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-3-传递参数"><span class="toc-text">6.3 传递参数</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#IN-输入"><span class="toc-text">IN - 输入</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#OUT-输出"><span class="toc-text">OUT-输出</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-4-case结构"><span class="toc-text">6.4 case结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-5-while循环"><span class="toc-text">6.5 while循环</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-6-repeat结构"><span class="toc-text">6.6 repeat结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-7-loop语句"><span class="toc-text">6.7 loop语句</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-8-leave语句"><span class="toc-text">6.8 leave语句</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-9-游标-光标"><span class="toc-text">6.9 游标&#x2F;光标</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-存储函数"><span class="toc-text">7. 存储函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#☆"><span class="toc-text">☆</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/images/qad.jpg"></div><div class="author-info-name">DuanChaojie</div><div class="author-info-description">DuanChaojie的个人博客</div><div class="links-buttons"><a class="links-button button-hover" href="https://www.itbuild.cn" target="_blank">QQ: 1585636331<i class="icon-dot bg-color6"></i></a><a class="links-button button-hover" href="https://www.itbuild.cn" target="_blank">手机：17351015389<i class="icon-dot bg-color7"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">星星</span><span class="pull-bottom">122</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">11</span></a></div><div class="friend-link"><a class="friend-link-text" href="http://www.cyc2018.xyz/" target="_blank">算法训练</a><a class="friend-link-text" href="https://www.bilibili.com/" target="_blank">相约B站</a><a class="friend-link-text" href="https://account.aliyun.com/" target="_blank">图床地址</a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="title-name" href="/">it❤ld</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">MySql高级/3.MySql高级之存储过程和函数</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2020-12-19 | 更新于 2020-12-19</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/MySql%E9%AB%98%E7%BA%A7/">MySql高级</a></div><div class="button-hover tags"></div></div></div><div class="main-content"><p>吴山青，越山青。两岸青山相送迎。谁知离别情？</p>
<p align="right">——林逋《长相思》</p>
<a id="more"></a>


<h2 id="MySql高级之存储过程和函数"><a href="#MySql高级之存储过程和函数" class="headerlink" title="MySql高级之存储过程和函数"></a>MySql高级之存储过程和函数</h2><h4 id="1-存储过程和函数概述"><a href="#1-存储过程和函数概述" class="headerlink" title="1. 存储过程和函数概述"></a>1. 存储过程和函数概述</h4><blockquote>
<p>存储过程和函数是事先经过编译并存储在数据库中的一段 SQL 语句的集合，调用存储过程和函数可以简化应用开发人员的很多工作，减少数据在数据库和应用服务器之间的传输，对于提高数据处理的效率是有好处的。    </p>
<p>存储过程和函数的区别在于函数必须有返回值，而存储过程没有。</p>
<ol>
<li><p>函数 ： 是一个有返回值的过程 ；</p>
</li>
<li><p>过程 ： 是一个没有返回值的函数 ；</p>
</li>
</ol>
</blockquote>
<h4 id="2-创建存储过程"><a href="#2-创建存储过程" class="headerlink" title="2. 创建存储过程"></a>2. 创建存储过程</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> procedure_name ([proc_parameter[,...]])</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="comment">-- SQL语句</span></span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#示例 ：</span></span><br><span class="line">delimiter $</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pro_test1()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">select</span> <span class="string">'Hello Mysql'</span>;</span><br><span class="line"><span class="keyword">end</span>$</span><br></pre></td></tr></table></figure>

<p><strong><font color="red">知识小贴士</font></strong></p>
<blockquote>
<p><code>delimiter</code></p>
<p>​    该关键字用来声明SQL语句的分隔符 , 告诉 MySQL 解释器，该段命令是否已经结束了，mysql是否可以执行了。<code>默认情况下，delimiter是分号;</code>。在命令行客户端中，如果有一行命令以分号结束，那么回车后，mysql将会执行该命令。</p>
</blockquote>
<h4 id="3-调用存储过程"><a href="#3-调用存储过程" class="headerlink" title="3.  调用存储过程"></a>3.  调用存储过程</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> pro_test1()$</span><br></pre></td></tr></table></figure>

<h4 id="4-查看存储过程"><a href="#4-查看存储过程" class="headerlink" title="4. 查看存储过程"></a>4. 查看存储过程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查询存储过程的状态信息</span><br><span class="line">show procedure status\G$</span><br><span class="line"></span><br><span class="line"># 查询某个存储过程的定义</span><br><span class="line">show create procedure pro_test1 \G$</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/MySql%E9%AB%98%E7%BA%A7/image-20200727101850538.png" alt="image-20200727101850538"></p>
<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/MySql%E9%AB%98%E7%BA%A7/image-20200727102025580.png" alt="image-20200727102025580"></p>
<h4 id="5-删除存储过程"><a href="#5-删除存储过程" class="headerlink" title="5. 删除存储过程"></a>5. 删除存储过程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drop procedure if exists pro_test1$</span><br></pre></td></tr></table></figure>

<h4 id="6-语法"><a href="#6-语法" class="headerlink" title="6. 语法"></a>6. 语法</h4><blockquote>
<p><code>存储过程是可以编程的，意味着可以使用变量，表达式，控制结构 ， 来完成比较复杂的功能。</code></p>
</blockquote>
<h5 id="6-1-变量"><a href="#6-1-变量" class="headerlink" title="6.1 变量"></a>6.1 变量</h5><blockquote>
<p><code>通过 declare可以定义一个局部变量，该变量的作用范围只能在 begin…end块中。</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">declare var_name[,...] type [default value]</span><br><span class="line"># 示例 : </span><br><span class="line">create procedure pro_test2() </span><br><span class="line">begin </span><br><span class="line"> 	declare num int default 2;</span><br><span class="line"> 	select num + 9; </span><br><span class="line">end$</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/MySql%E9%AB%98%E7%BA%A7/image-20200727104732800.png" alt="image-20200727104732800"></p>
<blockquote>
<p>直接赋值使用 set，可以赋常量或者赋表达式，具体语法如下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">set var_name &#x3D; expr [, var_name &#x3D; expr] ...</span><br><span class="line">#示例 : </span><br><span class="line">create procedure pri_test3()</span><br><span class="line">begin </span><br><span class="line">	declare name varchar(20);</span><br><span class="line">	set name &#x3D; &quot;MySql&quot;;</span><br><span class="line">	select name;</span><br><span class="line">end$</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/MySql%E9%AB%98%E7%BA%A7/image-20200727105742087.png" alt="image-20200727105742087"></p>
<blockquote>
<p>也可以通过select … into 方式进行赋值操作 :</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pro_test4()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> countnum <span class="built_in">int</span>;</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">into</span> countnum <span class="keyword">from</span> city;</span><br><span class="line">    <span class="keyword">select</span> countnum;</span><br><span class="line"><span class="keyword">end</span>$</span><br></pre></td></tr></table></figure>

<h5 id="6-2-if条件判断"><a href="#6-2-if条件判断" class="headerlink" title="6.2 if条件判断"></a>6.2 if条件判断</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#语法结构 : </span><br><span class="line">if search_condition then statement_list</span><br><span class="line">	[elseif search_condition then statement_list] ...</span><br><span class="line">	[else statement_list]</span><br><span class="line">end if;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需求： 根据定义的身高变量，判定当前身高的所属的身材类型 </p>
<ul>
<li><code>180 及以上 ----------&gt; 身材高挑</code></li>
<li><code>170 - 180  ---------&gt; 标准身材</code></li>
<li><code>170 以下  ----------&gt; 一般身材</code></li>
</ul>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pro_test5()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> height <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">175</span>;</span><br><span class="line">    <span class="keyword">declare</span> des <span class="built_in">varchar</span>(<span class="number">20</span>);</span><br><span class="line">    if height &gt;= 180 then</span><br><span class="line">        <span class="keyword">set</span> des = <span class="string">'身材高挑'</span>;</span><br><span class="line">    elseif height &gt;=170 and height &lt; 180 then</span><br><span class="line">        <span class="keyword">set</span> des = <span class="string">'标准身材'</span>;</span><br><span class="line">    else </span><br><span class="line">        <span class="keyword">set</span> des = <span class="string">'一般身材'</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line">    <span class="keyword">select</span> des;</span><br><span class="line"><span class="keyword">end</span>$</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/MySql%E9%AB%98%E7%BA%A7/image-20200727111942527.png" alt="image-20200727111942527"></p>
<h5 id="6-3-传递参数"><a href="#6-3-传递参数" class="headerlink" title="6.3 传递参数"></a>6.3 传递参数</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 语法格式 : </span><br><span class="line">create procedure procedure_name([in&#x2F;out&#x2F;inout] 参数名   参数类型)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">IN :   该参数可以作为输入，也就是需要调用方传入值 , 默认</span><br><span class="line">OUT:   该参数作为输出，也就是该参数可以作为返回值</span><br><span class="line">INOUT: 既可以作为输入参数，也可以作为输出参数</span><br></pre></td></tr></table></figure>

<h6 id="IN-输入"><a href="#IN-输入" class="headerlink" title="IN - 输入"></a>IN - 输入</h6><p>需求 :根据定义的身高变量，判定当前身高的所属的身材类型 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#示例</span><br><span class="line">create procedure pro_test6(in height int)</span><br><span class="line">begin</span><br><span class="line">  declare des varchar(50) default &#39;&#39;;</span><br><span class="line">  if height &gt;&#x3D; 180 then</span><br><span class="line">    set des &#x3D;&#39;身材高挑&#39;;</span><br><span class="line">  elseif height &gt;&#x3D; 170 and height &lt; 180 then</span><br><span class="line">    set des &#x3D;&#39;标准身材&#39;;</span><br><span class="line">  else</span><br><span class="line">    set des &#x3D;&#39;一般身材&#39;;</span><br><span class="line">  end if;</span><br><span class="line">  select concat(&#39;身高 &#39;, height , &#39;对应的身材类型为:&#39;,des) as result;</span><br><span class="line">end$</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/MySql%E9%AB%98%E7%BA%A7/image-20200727112544537.png" alt="image-20200727112544537"></p>
<h6 id="OUT-输出"><a href="#OUT-输出" class="headerlink" title="OUT-输出"></a>OUT-输出</h6><blockquote>
<p> 需求 :根据传入的身高变量，获取当前身高的所属的身材类型</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#示例:</span><br><span class="line">create procedure pro_test7(in height int , out des varchar(100))</span><br><span class="line">begin</span><br><span class="line">  if height &gt;&#x3D; 180 then</span><br><span class="line">    set des &#x3D;&#39;身材高挑&#39;;</span><br><span class="line">  elseif height &gt;&#x3D; 170 and height &lt; 180 then</span><br><span class="line">    set des &#x3D;&#39;标准身材&#39;;</span><br><span class="line">  else</span><br><span class="line">    set des &#x3D;&#39;一般身材&#39;;</span><br><span class="line">  end if;</span><br><span class="line">end$</span><br></pre></td></tr></table></figure>

<blockquote>
<p>调用</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">call pro_test5(168, @description)$</span><br><span class="line">select @description$</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/MySql%E9%AB%98%E7%BA%A7/image-20200727112836446.png" alt="image-20200727112836446"></p>
<p><font color='red'><strong>小知识</strong> </font></p>
<blockquote>
<p><code>@description :  这种变量要在变量名称前面加上“@”符号，叫做用户会话变量，代表整个会话过程他都是有作用的，这个类似于全局变量一样。</code></p>
<p><code>@@global.sort_buffer_size : 这种在变量前加上 &quot;@@&quot; 符号, 叫做 系统变量</code> </p>
</blockquote>
<h5 id="6-4-case结构"><a href="#6-4-case结构" class="headerlink" title="6.4 case结构"></a>6.4 case结构</h5><blockquote>
<p>语法结构 : </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">方式一 : </span><br><span class="line">CASE case_value</span><br><span class="line">  WHEN when_value THEN statement_list</span><br><span class="line">  [WHEN when_value THEN statement_list] ...</span><br><span class="line">  [ELSE statement_list]</span><br><span class="line">END CASE;</span><br><span class="line"></span><br><span class="line">方式二 : </span><br><span class="line">CASE</span><br><span class="line">  WHEN search_condition THEN statement_list</span><br><span class="line">  [WHEN search_condition THEN statement_list] ...</span><br><span class="line">  [ELSE statement_list]</span><br><span class="line">END CASE;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需求:给定一个月份, 然后计算出所在的季度</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#示例  :</span><br><span class="line">create procedure pro_test8(month int)</span><br><span class="line">begin</span><br><span class="line">  declare result varchar(20);</span><br><span class="line">  case </span><br><span class="line">    when month &gt;&#x3D; 1 and month &lt;&#x3D;3 then </span><br><span class="line">      set result &#x3D; &#39;第一季度&#39;;</span><br><span class="line">    when month &gt;&#x3D; 4 and month &lt;&#x3D;6 then </span><br><span class="line">      set result &#x3D; &#39;第二季度&#39;;</span><br><span class="line">    when month &gt;&#x3D; 7 and month &lt;&#x3D;9 then </span><br><span class="line">      set result &#x3D; &#39;第三季度&#39;;</span><br><span class="line">    when month &gt;&#x3D; 10 and month &lt;&#x3D;12 then </span><br><span class="line">      set result &#x3D; &#39;第四季度&#39;;</span><br><span class="line">  end case;</span><br><span class="line">  select concat(&#39;您输入的月份为 :&#39;, month , &#39; , 该月份为 : &#39; , result) as content ;</span><br><span class="line">end$</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/MySql%E9%AB%98%E7%BA%A7/image-20200727115247463.png" alt="image-20200727115247463"></p>
<h5 id="6-5-while循环"><a href="#6-5-while循环" class="headerlink" title="6.5 while循环"></a>6.5 while循环</h5><blockquote>
<p>语法结构: </p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">while search_condition <span class="keyword">do</span></span><br><span class="line">	statement_list</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">while</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>需求:计算从1加到n的值</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#示例  : </span><br><span class="line">create procedure pro_test9(n int)</span><br><span class="line">begin</span><br><span class="line">  declare total int default 0;</span><br><span class="line">  declare num int default 1;</span><br><span class="line">  while num&lt;&#x3D;n do</span><br><span class="line">    set total &#x3D; total + num;</span><br><span class="line">	set num &#x3D; num + 1;</span><br><span class="line">  end while;</span><br><span class="line">  select total;</span><br><span class="line">end$</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/MySql%E9%AB%98%E7%BA%A7/image-20200727115640901.png" alt="image-20200727115640901"></p>
<h5 id="6-6-repeat结构"><a href="#6-6-repeat结构" class="headerlink" title="6.6 repeat结构"></a>6.6 repeat结构</h5><blockquote>
<p><code>有条件的循环控制语句, 当满足条件的时候退出循环 。while 是满足条件才执行，repeat 是满足条件就退出循环。</code>语法结构 : </p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">repeat</span><br><span class="line">  statement_list</span><br><span class="line">  until search_condition</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">repeat</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需求: 计算从1加到n的值</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#示例</span><br><span class="line">create procedure pro_test10(n int)</span><br><span class="line">begin</span><br><span class="line">  declare total int default 0;</span><br><span class="line">  repeat </span><br><span class="line">    set total &#x3D; total + n;</span><br><span class="line">    set n &#x3D; n - 1;</span><br><span class="line">    until n&#x3D;0  </span><br><span class="line">  end repeat;</span><br><span class="line">  select total ;</span><br><span class="line">  </span><br><span class="line">end$</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/MySql%E9%AB%98%E7%BA%A7/image-20200727120024840.png" alt="image-20200727120024840"></p>
<h5 id="6-7-loop语句"><a href="#6-7-loop语句" class="headerlink" title="6.7 loop语句"></a>6.7 loop语句</h5><blockquote>
<p>LOOP 实现简单的循环，退出循环的条件需要使用其他的语句定义，通常可以使用 LEAVE 语句实现，具体语法如下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[begin_label:] loop</span><br><span class="line">  statement_list</span><br><span class="line">end loop [end_label]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果不在 statement_list 中增加退出循环的语句，那么 LOOP 语句可以用来实现简单的死循环。</p>
</blockquote>
<h5 id="6-8-leave语句"><a href="#6-8-leave语句" class="headerlink" title="6.8 leave语句"></a>6.8 leave语句</h5><blockquote>
<p>用来从标注的流程构造中退出，通常和 BEGIN … END 或者循环一起使用。下面是一个使用 LOOP 和 LEAVE 的简单例子 , 退出循环：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">create procedure pro_test11(n int)</span><br><span class="line">begin</span><br><span class="line">	declare total int default 0;</span><br><span class="line">	ins: loop</span><br><span class="line">		if n &lt;&#x3D; 0 then</span><br><span class="line">			leave ins;</span><br><span class="line">        end if;</span><br><span class="line">        set total &#x3D; total + n;</span><br><span class="line">        set n &#x3D; n - 1;</span><br><span class="line">    end loop ins;</span><br><span class="line">    </span><br><span class="line">    select total;</span><br><span class="line">end$</span><br></pre></td></tr></table></figure>

<p><img src="https://oss-blogs.oss-cn-hangzhou.aliyuncs.com/blogs/itbuild/MySql%E9%AB%98%E7%BA%A7/image-20200727120757714.png" alt="image-20200727120757714"></p>
<h5 id="6-9-游标-光标"><a href="#6-9-游标-光标" class="headerlink" title="6.9 游标/光标"></a>6.9 游标/光标</h5><p>游标是用来存储查询结果集的数据类型 , 在存储过程和函数中可以使用光标对结果集进行循环的处理。光标的使用包括光标的声明、OPEN、FETCH 和 CLOSE，其语法分别如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#声明光标：</span><br><span class="line">declare cursor_name cursor for select_statement;</span><br><span class="line"></span><br><span class="line">#OPEN 光标：</span><br><span class="line">open cursor_name;</span><br><span class="line"></span><br><span class="line">#FETCH 光标：</span><br><span class="line">fetch cursor_name into var_name [, var_name] ...</span><br><span class="line"></span><br><span class="line">#CLOSE 光标：</span><br><span class="line">close cursor_name ;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>示例 :</code> </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#初始化脚本</span><br><span class="line">create table emp(</span><br><span class="line">  id int(11) not null auto_increment ,</span><br><span class="line">  name varchar(50) not null comment &#39;姓名&#39;,</span><br><span class="line">  age int(11) comment &#39;年龄&#39;,</span><br><span class="line">  salary int(11) comment &#39;薪水&#39;,</span><br><span class="line">  primary key(&#96;id&#96;)</span><br><span class="line">)engine&#x3D;innodb default charset&#x3D;utf8 ;</span><br><span class="line"></span><br><span class="line">insert into emp(id,name,age,salary) values(null,&#39;金毛狮王&#39;,55,3800),(null,&#39;白眉鹰王&#39;,60,4000),(null,&#39;青翼蝠王&#39;,38,2800),(null,&#39;紫衫龙王&#39;,42,1800);</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>查询emp表中数据, 并逐行获取进行展示</code></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pro_test12()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">declare</span> e_id <span class="built_in">int</span>(<span class="number">11</span>);</span><br><span class="line">  <span class="keyword">declare</span> e_name <span class="built_in">varchar</span>(<span class="number">50</span>);</span><br><span class="line">  <span class="keyword">declare</span> e_age <span class="built_in">int</span>(<span class="number">11</span>);</span><br><span class="line">  <span class="keyword">declare</span> e_salary <span class="built_in">int</span>(<span class="number">11</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">declare</span> emp_result <span class="keyword">cursor</span> <span class="keyword">for</span> <span class="keyword">select</span> * <span class="keyword">from</span> emp;</span><br><span class="line">  </span><br><span class="line">  open emp_result;</span><br><span class="line">  </span><br><span class="line">  fetch emp_result into e_id,e_name,e_age,e_salary;</span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">concat</span>(<span class="string">'id='</span>,e_id , <span class="string">', name='</span>,e_name, <span class="string">', age='</span>, e_age, <span class="string">', 薪资为: '</span>,e_salary);</span><br><span class="line">  </span><br><span class="line">  fetch emp_result into e_id,e_name,e_age,e_salary;</span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">concat</span>(<span class="string">'id='</span>,e_id , <span class="string">', name='</span>,e_name, <span class="string">', age='</span>, e_age, <span class="string">', 薪资为: '</span>,e_salary);</span><br><span class="line">  </span><br><span class="line">  fetch emp_result into e_id,e_name,e_age,e_salary;</span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">concat</span>(<span class="string">'id='</span>,e_id , <span class="string">', name='</span>,e_name, <span class="string">', age='</span>, e_age, <span class="string">', 薪资为: '</span>,e_salary);</span><br><span class="line">  </span><br><span class="line">  fetch emp_result into e_id,e_name,e_age,e_salary;</span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">concat</span>(<span class="string">'id='</span>,e_id , <span class="string">', name='</span>,e_name, <span class="string">', age='</span>, e_age, <span class="string">', 薪资为: '</span>,e_salary);</span><br><span class="line">  </span><br><span class="line">  fetch emp_result into e_id,e_name,e_age,e_salary;</span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">concat</span>(<span class="string">'id='</span>,e_id , <span class="string">', name='</span>,e_name, <span class="string">', age='</span>, e_age, <span class="string">', 薪资为: '</span>,e_salary);</span><br><span class="line">  </span><br><span class="line">  close emp_result;</span><br><span class="line"><span class="keyword">end</span>$</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通过循环结构 , 获取游标中的数据 : </p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pro_test13()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">declare</span> <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>);</span><br><span class="line">	<span class="keyword">declare</span> <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">50</span>);</span><br><span class="line">	<span class="keyword">declare</span> age <span class="built_in">int</span>(<span class="number">11</span>);</span><br><span class="line">	<span class="keyword">declare</span> salary <span class="built_in">int</span>(<span class="number">11</span>);</span><br><span class="line">	<span class="keyword">declare</span> has_data <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">declare</span> emp_result <span class="keyword">cursor</span> <span class="keyword">for</span> <span class="keyword">select</span> * <span class="keyword">from</span> emp;</span><br><span class="line">	<span class="keyword">declare</span> <span class="keyword">exit</span> <span class="keyword">handler</span> <span class="keyword">for</span> <span class="keyword">not</span> <span class="keyword">found</span> <span class="keyword">set</span> has_data = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	open emp_result;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">  repeat</span><br><span class="line">    fetch emp_result into id , name , age , salary;</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">concat</span>(<span class="string">'id为'</span>,<span class="keyword">id</span>, <span class="string">', name 为'</span> ,<span class="keyword">name</span> , <span class="string">', age为 '</span> ,age , <span class="string">', 薪水为: '</span>, salary);</span><br><span class="line">    until has_data = 0</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">repeat</span>;</span><br><span class="line">  </span><br><span class="line">  close emp_result;</span><br><span class="line"><span class="keyword">end</span>$</span><br></pre></td></tr></table></figure>

<h4 id="7-存储函数"><a href="#7-存储函数" class="headerlink" title="7. 存储函数"></a>7. 存储函数</h4><blockquote>
<p>语法结构:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create function function_name([param type ...])</span><br><span class="line">returns type</span><br><span class="line">begin</span><br><span class="line">	...</span><br><span class="line">end$</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>案例 : 定义一个存储过程, 请求满足条件的总记录数 ;</code></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> count_city(countryId <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">returns</span> <span class="built_in">int</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">declare</span> cnum <span class="built_in">int</span> ;</span><br><span class="line">  <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">into</span> cnum <span class="keyword">from</span> city <span class="keyword">where</span> country_id = countryId;</span><br><span class="line">  return cnum;</span><br><span class="line"><span class="keyword">end</span>$</span><br></pre></td></tr></table></figure>

<blockquote>
<p>调用: </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select count_city(1)$</span><br><span class="line"></span><br><span class="line">select count_city(2)$</span><br></pre></td></tr></table></figure>

<h2 id="☆"><a href="#☆" class="headerlink" title="☆"></a>☆</h2></div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">DuanChaojie</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="http://www.itbuild.cn/2020/12/19/MySql%E9%AB%98%E7%BA%A7/3.MySql%E9%AB%98%E7%BA%A7%E4%B9%8B%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E5%92%8C%E5%87%BD%E6%95%B0/">http://www.itbuild.cn/2020/12/19/MySql%E9%AB%98%E7%BA%A7/3.MySql%E9%AB%98%E7%BA%A7%E4%B9%8B%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E5%92%8C%E5%87%BD%E6%95%B0/</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.itbuild.cn">it❤ld</a>！</span></div></div></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2020/12/19/MySql%E9%AB%98%E7%BA%A7/4.MySql%E9%AB%98%E7%BA%A7%E4%B9%8B%E8%A7%A6%E5%8F%91%E5%99%A8/"><i class="fas fa-angle-left">&nbsp;</i><span>MySql高级/4.MySql高级之触发器</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2020/12/19/MySql%E9%AB%98%E7%BA%A7/2.MySql%E9%AB%98%E7%BA%A7%E4%B9%8B%E8%A7%86%E5%9B%BE/"><span>MySql高级/2.MySql高级之视图</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2020 By DuanChaojie</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--></body></html>